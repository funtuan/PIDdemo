
<!-- saved from url=(0507)https://ec73vlph02nn03goec7umti1ai3tii29-a-sites-opensocial.googleusercontent.com/gadgets/ifr?url=http://sites.google.com/site/fpgaandco/pid/gad.xml&container=enterprise&view=default&lang=en&country=ALL&sanitize=0&v=2686b7ec8e5bf30f&libs=core&mid=162&parent=https://sites.google.com/site/fpgaandco/pid#st=e%3DAIHE3cCLDVpOYGCpZoOVUBZJngOMHggzc%252FgAjdYaVBASLDc1RjbqUCK5TKyi1QQNyIJRqYKgifpmSRMdfGALozAj9ztD8ID7Wk%252FjZ0%252F89rn4yU2ykDzpIHfD7jBepG0WX5wmjATr5VA4%26c%3Denterprise&rpctoken=-299098951986249413 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(){(function(){function e(g){this.t={};this.tick=function(h,m,f){var n=void 0!=f?f:(new Date).getTime();this.t[h]=[n,m];if(void 0==f)try{window.console.timeStamp("CSI/"+h)}catch(q){}};this.tick("start",null,g)}var a;if(window.performance)var d=(a=window.performance.timing)&&a.responseStart;var p=0<d?new e(d):new e;window.jstiming={Timer:e,load:p};if(a){var b=a.navigationStart;0<b&&d>=b&&(window.jstiming.srt=d-b)}if(a){var c=window.jstiming.load;0<b&&d>=b&&(c.tick("_wtsrt",void 0,b),c.tick("wtsrt_","_wtsrt",
d),c.tick("tbsd_","wtsrt_"))}try{var k=window.top!=window.self,l=window.location.href;a=null;window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),c&&0<b&&(c.tick("_tbnd",void 0,window.chrome.csi().startE),c.tick("tbnd_","_tbnd",b)));null==a&&window.gtbExternal&&(a=k?window.gtbExternal.frameT(l):window.gtbExternal.pageT());null==a&&window.external&&(k?a=window.external.frameT(l):(a=window.external.pageT,c&&0<b&&(c.tick("_tbnd",void 0,window.external.startE),c.tick("tbnd_","_tbnd",
b))));a&&(window.jstiming.pt=a)}catch(g){}})();}).call(this);
window["__csi"]={a:false,b:false,c:"enterprise",v:"default",g:null,d:false};if(window.jstiming){window.jstiming.beaconImageReferences_={};window.jstiming.reportCounter_=1;var getTick=function(c,a,f){var b=c.t[a],d=c.t.start;if(b&&(d||f))return b=c.t[a][0],d=void 0!=f?f:d[0],c=b-d,Math.round(c)},getReportUri=function(c,a,f){var b="";window.jstiming.srt&&(b+="&srt="+window.jstiming.srt,delete window.jstiming.srt);window.jstiming.pt&&(b+="&tbsrt="+window.jstiming.pt,delete window.jstiming.pt);try{window.external&&window.external.tran?b+="&tran="+window.external.tran:window.gtbExternal&&
window.gtbExternal.tran?b+="&tran="+window.gtbExternal.tran():window.chrome&&window.chrome.csi&&(b+="&tran="+window.chrome.csi().tran)}catch(l){}var d=window.chrome;if(d&&(d=d.loadTimes)){d().wasFetchedViaSpdy&&(b+="&p=s");if(d().wasNpnNegotiated){b+="&npn=1";var g=d().npnNegotiatedProtocol;g&&(b+="&npnv="+(encodeURIComponent||escape)(g))}d().wasAlternateProtocolAvailable&&(b+="&apa=1")}var h=c.t,n=h.start;d=[];g=[];for(var k in h)if("start"!=k&&0!=k.indexOf("_")){var q=h[k][1];q?h[q]&&g.push(k+"."+
getTick(c,k,h[q][0])):n&&d.push(k+"."+getTick(c,k))}delete h.start;if(a)for(var e in a)b+="&"+e+"="+a[e];(a=f)||(a="https:"==document.location.protocol?"https://csi.gstatic.com/csi":"http://csi.gstatic.com/csi");return c=[a,"?v=3","&s="+(window.jstiming.sn||"opensocial-gadgets")+"&action=",c.name,g.length?"&it="+g.join(","):"",b,"&rt=",d.join(",")].join("")},sendReport_=function(c,a,f){c=getReportUri(c,a,f);if(!c)return"";a=new Image;var b=window.jstiming.reportCounter_++;window.jstiming.beaconImageReferences_[b]=
a;a.onload=a.onerror=function(){window.jstiming&&delete window.jstiming.beaconImageReferences_[b]};a.src=c;a=null;return c};window.jstiming.report=function(c,a,f){var b=document.visibilityState,d="visibilitychange";b||(b=document.webkitVisibilityState,d="webkitvisibilitychange");if("prerender"==b){var g=!1,h=function(){if(!g){a?a.prerender="1":a={prerender:"1"};if("prerender"==(document.visibilityState||document.webkitVisibilityState))var n=!1;else sendReport_(c,a,f),n=!0;n&&(g=!0,document.removeEventListener(d,
h,!1))}};document.addEventListener(d,h,!1);return""}return sendReport_(c,a,f)}};var google=window.google||{};
google.csi=function(){function c(e){var l=h?h:document.location.href;return(e=l.match(new RegExp("[?&]"+e+"=([^&#]+)")))?e[1]:null}function a(e){window.jstiming.load.tick(e);g[e]=(new Date).getTime()}function f(){if(!k){var e=c("url")||"default",l=window.__csi||{},r=l.c||"default",v=l.v||"default",p=window.encodeURIComponent?encodeURIComponent:escape;p={gadget:p(e),container:p(r),view:p(v)};var t=window.__dflags||{},u=[];l.g&&u.push(l.g);if(l.d)for(var m in t)"control"!==t[m]&&(p[m]=t[m],"true"===
t[m]&&u.push(m));p.e=u.join(",");m=n?n:document.location.protocol;m=d[m];window.jstiming.load.name=[r,"_",v].join("");window.jstiming.report(window.jstiming.load,p,m);(r=window.gadgets)&&r.rpc&&l.b&&(g.url=e,g.id=c("mid"),r.rpc.call(null,"time_iframe",void 0,g));k=!0}}function b(e){window.addEventListener?window.addEventListener("load",e,!1):window.attachEvent&&window.attachEvent("onload",e)}var d={"http:":"http://csi.gstatic.com/csi","https:":"https://gg.google.com/csi"},g={},h,n,k=!1,q=window.__csi||
{};q.a?(b(function(){a("prt")}),window.onbeforeunload=function(){f()}):b(function(){a("ol");a("prt");f()});return{reset_:function(){k=!1},mockHref_:function(e){h=e},mockProtocol_:function(e){n=e},report_:f,tickPrtAndReport:function(){a("prt");f()},tickDl:function(){a("dl")}}}();
</script><script>__dflags={"RefererProxy":"control","DynamicHeightGadgetRewriter":"true","CacheErrorThrottleCountLimit":"control","AnalyticsGadgetRewriter":"true","StyleAdjacencyGadgetRewriter":"true","CsiSample":"true","UseETags":"false","ImageOnlyProxy":"false","StyleTagExtractorGadgetRewriter":"true","JsSubVersion":"control","LogResources":"false","ContentDivGadgetRewriter":"false","TimeSecsSinceEpochEnvGadgetRewriter":"true","AdsUrlGadgetRewriter":"true","ErrorCodesToLog":"control","YtVideoUrlGadgetRewriter":"true","ProxyingGadgetRewriter":"true","UseIfrVersion":"true","ForceCoreNoneRequireFeatures":"false","FastnetCheckUri":"true","UseCajaSerializer":"false","IfrSubVersion":"control","BigstoreHosts":"control","GoogleImageResponseRewriter":"true","CorpDomainSuffixes":"control","CacheErrorThrottleReturnCode":"control","DflagsJsDebugGadgetRewriter":"true","GadgetBlacklist":"control","MiniMessageGadgetRewriter":"true","UseJsHintIfAvailable":"false","TrackResources":"false","FastnetValidateSslCert":"false","ClickTrackGadgetRewriter":"false","InjectClientId":"false","ImageProxyErrorOnInvalidImage":"false","HarpoonMaxPageSize":"control","HtmlParser":"control","UseUrlGadgetWhitelist":"false","CacheErrorThrottleCountTime":"control","ResourceUsageJsDebugGadgetRewriter":"true","UrlTranslations":"control","EnableContextCache":"false","Monkeypatch":"control","ValidateTypeUrl":"true","UseJsPipelineForRendering":"false"};

/* mp-start */
window['___jsl']=window['___jsl']||{};
/* mp-end */
</script><style type="text/css">body,td,div,span,p{font-family:arial,sans-serif;}a {color:#0000cc;}a:visited {color:#551a8b;}a:active {color:#ff0000;}body{margin: 0px;padding: 0px;background-color:white;}</style><script>window['__isgadget']=true;</script><script src="./core.js"></script><script>window['___jsl'] = window['___jsl'] || {};(window['___jsl']['ci'] = (window['___jsl']['ci'] || [])).push({"core.io":{"jsonProxyUrl":"//%host%/gadgets/makeRequest","proxyUrl":"//www-sites-opensocial.googleusercontent.com/gadgets/proxy/refresh=%refresh%&container=%container%%rewriteMime%&gadget=%gadget%/%rawurl%"},"shindig.auth":{"authToken":"","trustedJson":""},"core.util":{"core":{}}});gadgets.config.init({"core.io":{"jsonProxyUrl":"//%host%/gadgets/makeRequest","proxyUrl":"//www-sites-opensocial.googleusercontent.com/gadgets/proxy/refresh=%refresh%&container=%container%%rewriteMime%&gadget=%gadget%/%rawurl%"},"shindig.auth":{"authToken":"","trustedJson":""},"core.util":{"core":{}}});
</script><script>gadgets.Prefs.setMessages_({});gadgets.Prefs.setDefaultPrefs_({});gadgets.io.preloaded_=[];</script>

		
		
		
	<style type="text/css">@font-face {
  font-family: "PjsEmptyFont";
  src: url('data:application/x-font-ttf;base64,AAEAAAAKAIAAAwAgT1MvMgAAAAAAAAEoAAAAVmNtYXAAAAAAAAABiAAAACxnbHlmAAAAAAAAAbwAAAAkaGVhZAAAAAAAAACsAAAAOGhoZWEAAAAAAAAA5AAAACRobXR4AAAAAAAAAYAAAAAGbG9jYQAAAAAAAAG0AAAABm1heHAAAAAAAAABCAAAACBuYW1lAAAAAAAAAeAAAAAgcG9zdAAAAAAAAAIAAAAAEAABAAAAAQAAAkgTY18PPPUACwAgAAAAALSRooAAAAAAyld0xgAAAAAAAQABAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAAACAAIAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACMAIwAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAMAAQAAAAwABAAgAAAABAAEAAEAAABB//8AAABB////wAABAAAAAAAAAAgAEgAAAAEAAAAAAAAAAAAAAAAxAAABAAAAAAABAAEAAQAAMTcBAQAAAAAAAgAeAAMAAQQJAAEAAAAAAAMAAQQJAAIAAgAAAAAAAQAAAAAAAAAAAAAAAAAA')
       format('truetype');
}</style></head><body dir="ltr"><script src="./processing-1.3.6.min.js"></script><script data-processing-target="hellocanvas" type="text/processing">

		// ----- Processing code ---------

/* @pjs preload="https://sites.google.com/site/fpgaandco/pid/car2.png,https://sites.google.com/site/fpgaandco/pid/grad.jpg"; */

Scrollbar hs1, hs2;
PImage carImg, grdImg;

int graphPos = 200, count = 0;
int[] lastGraphPos = new int[3];
int fps = 0;
float motorLimit = 1;

public PIDCtrl ctrl;
Vehicle car;

void setup()
{
  size(300, 400, P2D);
  textMode(SCREEN);

  noStroke();
  hs1 = new Scrollbar(10, 190, width-20, 10, 1);
  hs2 = new Scrollbar(0, 100, 10, 150, 1);
  carImg = loadImage("https://sites.google.com/site/fpgaandco/pid/car2.png");  
  grdImg = loadImage("https://sites.google.com/site/fpgaandco/pid/grad.jpg");
 
  ctrl = new PIDCtrl(1, 0.1, 0.2);
  car  = new Vehicle(.2, 0.0, radians(0));
  
  background(255);
}

void draw()
{  
  float carHeight = 50;

  //100 pixels = 1m
  float carPos = hs1.getPos() / 100.0;
  float error = carPos - car.position;
  float dt = 1.0 / (frameRate+0.000001);
  float force = ctrl.Update(error, dt);
  
  force = max(-motorLimit, min(motorLimit, force));

  car.slope = radians(-hs2.getPos()*.35);
  carPos = car.Update(force, dt) * 100.0;
  
  fill(255);
  stroke(255);
  rect(0,0,width,200);

  pushMatrix();
  translate(width/2,carHeight);
  rotate(car.slope);
  pushMatrix();
  translate(-200, -7);
  scale(70,1);
  image(grdImg, 0, 0);
  popMatrix();


  translate(carPos-24,carHeight-39);
  image(carImg, 0, 0);

  stroke(200,0,0);
  line(26, 24, 26+ctrl.ComponentP()*100, 24);
  stroke(0,200,0);
  line(26, 26, 26+ctrl.ComponentI()*100, 26);
  stroke(0,0,255);
  line(26, 28, 26+ctrl.ComponentD()*100, 28);
  popMatrix();   

  stroke(230);
  hs1.update();
  hs2.update();
  hs1.display();
  hs2.display();

  if(count%6==0)
    fps = int(frameRate);
  fill(100);
  text(fps+" fps", 5, 15);
  
  
  // graph
  if(count%2==0) {

    stroke(250);
    line(0,graphPos, 40,graphPos);
    stroke(255);
    line(41,graphPos, width,graphPos);

    int v;    
    stroke(240);
    point(20,graphPos);
    v = int(force/motorLimit*20)+20;
    if(v==lastGraphPos[2] && (v==0 || v==40))
      stroke(255,150,150);
    else
      stroke(180,250,180);
    line(v, graphPos, lastGraphPos[2], graphPos);
    lastGraphPos[2] = v;


    stroke(150);
    v = int(hs1.getPos()+width/2);
    line(v, graphPos, lastGraphPos[0], graphPos);
    lastGraphPos[0] = v;
  
    v = int(carPos+width/2);
    stroke(50,50,255);
    line(v, graphPos, lastGraphPos[1], graphPos);
    lastGraphPos[1] = v;

  
    graphPos++;
    if(graphPos>=height)
      graphPos=200;
  }
  count++;
}


void setProcessVars(float p, float i, float d, float mass, float damping, float maxf)
{
  ctrl.Kp=p;
  ctrl.Ki=i;
  ctrl.Kd=d; 
  
  car.mass = mass;
  car.damping = 1.0 - damping;
  motorLimit = maxf;
}

void resetCar()
{
  ctrl.ResetCtrl();
  car.Reset();
}

class PIDCtrl
{
  public float Kp, Ki, Kd;
  float lastError, integError;
  float compP, compI, compD;
  
  PIDCtrl(float p, float i, float d)
  {
    Kp = p;
    Ki = i;
    Kd = d;
    ResetCtrl();
  }
  
  void ResetCtrl()
  {
    lastError = 0.0;
    integError = 0.0;
  }
  
  float Update(float error, float dt)
  {
    integError += error * dt;
    compP = error * Kp;
    compI = integError * Ki;
    compD = ((error - lastError) / dt) * Kd;
    lastError = error;
    return compP + compI + compD;
  }
  
  float ComponentP() {
    return compP;
  }
  float ComponentI() {
    return compI;
  }
  float ComponentD() {
    return compD;
  }
  
}

class Vehicle
{
  public float mass;
  public float position;
  float velocity;
  public float damping;
  public float slope;
  
  Vehicle(float vMass, float vDamping, float vSlope)
  {
    mass = vMass;
    damping = 1.0 - vDamping;
    slope = vSlope;
    Reset();
  }
  
  float Update(float force, float dt)
  { 
    // consider the slope
    force += 9.81 * mass * sin(slope);
  
    // forward euler
    float accel = force / (mass+0.0001);
    velocity += accel * dt;
    velocity *= damping;
    position += velocity * dt;
    return position;
  }

  void Reset()
  {
    position=0;
    velocity=0;
  }  
}



public class Scrollbar
{
  int swidth, sheight;
  int xpos, ypos;
  float spos, newspos;
  int sposMin, sposMax;
  int sposMid;
  boolean over;
  boolean l;
  boolean locked;
  float ratio;

  public Scrollbar (int xp, int yp, int sw, int sh, int l) {
    swidth = sw;
    sheight = sh;
    ratio = (float)sw / (float)sh;
    xpos = xp;
    ypos = yp-sheight/2;
    if(ratio>=1.0) {
      spos = xpos + swidth/2 - sheight/2;
      sposMin = xpos;
      sposMax = xpos + swidth - sheight;
    }
    else {
      spos = ypos + sheight/2 - swidth/2;
      sposMin = ypos;
      sposMax = ypos + sheight - swidth;
    }
    newspos = spos;
    sposMid = (sposMax+sposMin)/2;
  }

  public void update() {
    if(Over()) {
      over = true;
    } else {
      over = false;
    }
    if(mousePressed && over) {
      if(mouseButton == RIGHT) {
        locked = false;
        spos = sposMid;
      }
      else if(mouseButton == LEFT)
        locked = true;
    }
    if(!mousePressed) {
      locked = false;
    }
    if(locked) {
      if(ratio>1.0) 
        spos = constrain(mouseX-sheight/2, sposMin, sposMax);
      else
        spos = constrain(mouseY-swidth/2, sposMin, sposMax);
    }
  }

  int constrain(int val, int minv, int maxv) {
    return min(max(val, minv), maxv);
  }

  boolean Over() {
    if(mouseX > xpos && mouseX < xpos+swidth &&
    mouseY > ypos && mouseY < ypos+sheight) {
      return true;
    } else {
      return false;
    }
  }

  void display() {
    fill(250,160);
    rect(xpos, ypos, swidth, sheight);
    if(over || locked) {
      fill(250, 190, 0);
    } else {
      fill(200);
    }
    if(ratio>1.0)
      rect(spos, ypos, sheight, sheight);
    else
      rect(xpos, spos, swidth, swidth);    
  }

  float getPos() {
    // Convert spos to be values between
    // 0 and the total width of the scrollbar
    return spos - sposMid;
  }
}




		// ----- end of Processing ---------
		</script><table border="1" bordercolor="white" cellspacing="0">
	<tbody>
		<tr>
			<td>
				<canvas height="400" id="hellocanvas" style="border: 2px solid rgb(221, 221, 221); image-rendering: -webkit-optimize-contrast !important;" width="300" tabindex="0">no HTML5 support</canvas>
			</td>
			<td style="vertical-align:top">
				<fieldset>
					<legend>PID parameters</legend>
					<div style="text-align:right">
					Kp: <input id="Kp" onchange="UpdateParameters()" size="10" type="text" value="1.0"><br>
					Ki: <input id="Ki" onchange="UpdateParameters()" size="10" type="text" value="0.1"><br>
					Kd: <input id="Kd" onchange="UpdateParameters()" size="10" type="text" value="0.2">
					</div>
				</fieldset>

				<fieldset>
					<legend>Car parameters</legend>
					<div style="text-align:right">
					mass(kg): <input id="mass" onchange="UpdateParameters()" size="10" type="text" value="0.2"><br>
					damping(0-1): <input id="damping" onchange="UpdateParameters()" size="10" type="text" value="0.0"><br>
					motor force limit(N): <input id="maxf" onchange="UpdateParameters()" size="10" type="text" value="1.0">
					</div>
				</fieldset>
				<button onclick="ResetCar()" type="button">Reset car</button>
			</td>
		</tr>
	</tbody>
	</table>

	<script type="text/javascript">

	  function loading()
	  {
		var canvas=document.getElementById('hellocanvas');
		var ctx=canvas.getContext('2d');
		ctx.fillStyle='#FF0000';
		ctx.fillRect(0,0,80,100);	
	  }
	  function UpdateParameters()
	  {
		   var txt_Kp = document.getElementById("Kp");
		   var txt_Ki = document.getElementById("Ki");
		   var txt_Kd = document.getElementById("Kd");
		   txt_Kp.value = isNaN(parseFloat(txt_Kp.value)) ? 0.0 : parseFloat(txt_Kp.value); 
		   txt_Ki.value = isNaN(parseFloat(txt_Ki.value)) ? 0.0 : parseFloat(txt_Ki.value); 
		   txt_Kd.value = isNaN(parseFloat(txt_Kd.value)) ? 0.0 : parseFloat(txt_Kd.value); 

		   var txt_mass = document.getElementById("mass");
		   var txt_damping = document.getElementById("damping");
		   var txt_maxf = document.getElementById("maxf");
		   txt_mass.value = isNaN(parseFloat(txt_mass.value)) ? 0.0 : parseFloat(txt_mass.value); 
		   txt_damping.value = isNaN(parseFloat(txt_damping.value)) ? 0.0 : Math.max(0.0, Math.min(1.0, parseFloat(txt_damping.value))); 
		   txt_maxf.value = isNaN(parseFloat(txt_maxf.value)) ? 0.0 : Math.max(0.0, parseFloat(txt_maxf.value)); 

		   var pjs = Processing.getInstanceById('hellocanvas');
		   pjs.setProcessVars(parseFloat(txt_Kp.value),parseFloat(txt_Ki.value),parseFloat(txt_Kd.value),
								parseFloat(txt_mass.value),parseFloat(txt_damping.value),parseFloat(txt_maxf.value));
		   
	  }
	  function ResetCar()
	  {
		   var pjs = Processing.getInstanceById('hellocanvas');
		   pjs.resetCar();
	  }
	</script>		

	
  <script>gadgets.util.runOnLoadHandlers();</script><script>window.google.csi.tickDl();
</script><span style="position: absolute; top: 0px; left: 0px; opacity: 0; font-family: PjsEmptyFont, fantasy;">AAAAAAAA</span></body></html>